{% extends "core/base.html" %}
{% block title %}Pacientes — Sistema Audiología{% endblock %}

{% block content %}
<div class="card border-0 shadow-sm">
  <div class="card-body">

    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center gap-3 flex-wrap">
      <div class="d-flex align-items-center gap-2">
        <span class="pill"><i class="bi bi-people"></i> Pacientes</span>
        <span class="section-sub d-none d-sm-inline">Búsqueda por nombre o RUT</span>
      </div>
      <a href="{% url 'patient_create' %}" class="btn btn-brand">
        <i class="bi bi-person-plus me-1"></i> Nuevo
      </a>
    </div>

    <!-- Buscador -->
    <form class="row g-2 mt-3" method="get" role="search">
      <div class="col-12 col-sm-8 col-md-6 col-lg-5">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
          <input class="form-control" type="search" name="q" value="{{ q }}" placeholder="Nombre o RUT (12.345.678-9)">
          {% if q %}
          <a class="btn btn-outline-secondary" href="{% url 'patient_list' %}" title="Limpiar">
            <i class="bi bi-x-lg"></i>
          </a>
          {% endif %}
        </div>
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-brand" type="submit">
          Buscar
        </button>
      </div>
    </form>

    <!-- Resultados -->
    <div class="table-responsive mt-3">
      <table class="table align-middle table-hover">
        <thead>
          <tr>
            <th><i class="bi bi-person-badge me-1"></i>RUT</th>
            <th><i class="bi bi-person me-1"></i>Nombre</th>
            <th><i class="bi bi-cake2 me-1"></i>Edad</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
        {% for p in patients %}
          <tr>
            <td class="fw-semibold">{{ p.rut }}</td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="rounded-2 d-inline-flex align-items-center justify-content-center"
                     style="width:28px;height:28px;background:var(--brand-50);border:1px solid var(--brand-200);color:var(--brand-800);font-weight:700;">
                  {% with ini=p.first_name|default_if_none:""|slice:":1"|upper inj=p.last_name|default_if_none:""|slice:":1"|upper %}
                  {{ ini }}{{ inj }}
                  {% endwith %}
                </div>
                <span class="text-truncate">{{ p.last_name }}, {{ p.first_name }}</span>
              </div>
            </td>
            <td>{% if p.birth_date %}{{ p.age_on }}{% else %}—{% endif %}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-brand" href="{% url 'patient_detail' p.pk %}">
                <i class="bi bi-arrow-up-right"></i> Abrir
              </a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4">
              <div class="text-center text-secondary py-4">
                <div class="mb-2" style="font-size:1.6rem;"><i class="bi bi-inboxes"></i></div>
                <div class="fw-semibold">Sin resultados.</div>
                <div class="small">Intenta con otro nombre o RUT, o crea un nuevo paciente.</div>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginación (opcional, solo si usas page_obj) -->
    {% if is_paginated %}
    <nav class="mt-3" aria-label="Paginación de pacientes">
      <ul class="pagination pagination-sm mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?q={{ q }}&page={{ page_obj.previous_page_number }}" aria-label="Anterior">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
        {% endif %}

        {% for num in paginator.page_range %}
          {% if num == page_obj.number %}
            <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
          {% elif num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
            <li class="page-item"><a class="page-link" href="?q={{ q }}&page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?q={{ q }}&page={{ page_obj.next_page_number }}" aria-label="Siguiente">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

  </div>
</div>
{% endblock %}
