{% extends "core/base.html" %}
{% block title %}Ficha — {{ patient.last_name }}, {{ patient.first_name }}{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- ===== Columna izquierda: Identidad del paciente / Acciones ===== -->
  <div class="col-12 col-xl-4">
    <div class="card h-100">
      <div class="card-body">
        <!-- Encabezado con avatar/monograma -->
        <div class="d-flex align-items-center gap-3 mb-3">
          <div class="rounded-3 d-inline-flex align-items-center justify-content-center"
               style="width:64px;height:64px;background:linear-gradient(135deg,var(--brand-500),var(--teal-500));color:#fff;font-weight:800;box-shadow:0 8px 22px rgba(47,149,255,.25);">
            {% with initials=patient.first_name|first|default:""|upper|add:patient.last_name|first|default:""|upper %}
              {{ initials }}
            {% endwith %}
          </div>
          <div>
            <h5 class="section-title mb-1">{{ patient.last_name }}, {{ patient.first_name }}</h5>
            <div class="text-secondary small">
              {% if patient.birth_date %}{{ patient.age_on }} años{% else %}Edad no registrada{% endif %}
            </div>
          </div>
        </div>

        <!-- Datos clave -->
        <div class="row g-2 mb-3">
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between p-2 rounded-3"
                 style="background:var(--brand-50);border:1px solid var(--brand-200);">
              <span class="text-secondary small d-flex align-items-center gap-2">
                <i class="bi bi-person-vcard"></i><strong>RUT</strong>
              </span>
              <span class="fw-semibold">{{ patient.rut }}</span>
            </div>
          </div>
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between p-2 rounded-3 border"
                 style="border-color: rgba(15,23,42,.08)!important;">
              <span class="text-secondary small d-flex align-items-center gap-2">
                <i class="bi bi-telephone"></i><strong>Teléfono</strong>
              </span>
              <span class="fw-semibold">{{ patient.phone|default:"—" }}</span>
            </div>
          </div>
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between p-2 rounded-3 border"
                 style="border-color: rgba(15,23,42,.08)!important;">
              <span class="text-secondary small d-flex align-items-center gap-2">
                <i class="bi bi-envelope"></i><strong>Email</strong>
              </span>
              <span class="fw-semibold text-truncate" style="max-width:60%">{{ patient.email|default:"—" }}</span>
            </div>
          </div>
        </div>

        <!-- Acciones principales -->
        <div class="d-grid gap-2">
          <a class="btn btn-brand" href="{% url 'anamnesis_create' patient.pk %}">
            <i class="bi bi-clipboard2-pulse me-1"></i> Nueva Anamnesis
          </a>
          <a class="btn btn-outline-brand" href="{% url 'audiogram_create' patient.pk %}">
            <i class="bi bi-activity me-1"></i> Nueva Audiometría
          </a>
          <div class="d-grid d-md-flex gap-2">
            <a class="btn btn-outline-secondary flex-fill" href="{% url 'speech_create' patient.pk %}">
              <i class="bi bi-chat-dots me-1"></i> Discriminación de la palabra
            </a>
            <a class="btn btn-outline-secondary flex-fill" href="{% url 'ldl_create' patient.pk %}">
              <i class="bi bi-soundwave me-1"></i> LDL
            </a>
          </div>
        </div>

        <!-- Nota UX -->
        <div class="small text-secondary mt-3">
          <i class="bi bi-info-circle me-1"></i>
          Mantén la ficha actualizada para agilizar informes y seguimiento.
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Columna derecha: Tabs ===== -->
  <div class="col-12 col-xl-8">
    <!-- Tabs con estilo -->
    <ul class="nav nav-tabs border-0" role="tablist" style="gap:.25rem;">
      <li class="nav-item" role="presentation">
        <button class="nav-link active fw-semibold"
                style="border-radius:10px 10px 0 0;"
                data-bs-toggle="tab" data-bs-target="#tab-anam" type="button" role="tab">
          <i class="bi bi-journal-text me-1"></i> Anamnesis
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link fw-semibold"
                style="border-radius:10px 10px 0 0;"
                data-bs-toggle="tab" data-bs-target="#tab-audio" type="button" role="tab">
          <i class="bi bi-graph-up-arrow me-1"></i> Audiometrías
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link fw-semibold"
                style="border-radius:10px 10px 0 0;"
                data-bs-toggle="tab" data-bs-target="#tab-speech" type="button" role="tab">
          <i class="bi bi-soundwave me-1"></i> Discriminación / LDL
        </button>
      </li>
    </ul>

    <div class="card border-0 shadow-sm">
      <div class="card-body p-0">
        <div class="tab-content p-3">

          <!-- === TAB: Anamnesis === -->
          <div id="tab-anam" class="tab-pane fade show active" role="tabpanel">
            {% if anamneses %}
              <div class="list-group list-group-flush">
                {% for a in anamneses %}
                  <div class="list-group-item py-3">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center gap-2">
                        <span class="pill"><i class="bi bi-calendar2-week"></i> {{ a.date }}</span>
                      </div>
                      <div class="text-secondary small">
                        ruido: {{ a.noise_exposure|yesno:"sí,no" }},
                        vértigo: {{ a.vertigo|yesno:"sí,no" }}
                      </div>
                    </div>
                    <div class="text-secondary small mt-2">
                      {{ a.main_complaint|default:"(sin descripción)" }}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center text-secondary py-4">
                <div class="mb-2" style="font-size:1.6rem;"><i class="bi bi-inboxes"></i></div>
                <div class="fw-semibold">Sin registros de anamnesis.</div>
                <div class="small">Comienza creando una desde la columna izquierda.</div>
              </div>
            {% endif %}
          </div>

          <!-- === TAB: Audiometrías === -->
          <div id="tab-audio" class="tab-pane fade" role="tabpanel">
            {% if audiograms %}
              <div class="table-responsive">
                <table class="table align-middle table-hover">
                  <thead>
                    <tr>
                      <th><i class="bi bi-calendar3 me-1"></i>Fecha</th>
                      <th><i class="bi bi-diagram-3 me-1"></i>Tipo</th>
                      <th>PTP OD</th>
                      <th>PTP OI</th>
                      <th>Comentarios</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ag in audiograms %}
                    <tr>
                      <td class="fw-semibold">{{ ag.date }}</td>
                      <td>{{ ag.get_exam_type_display }}</td>
                      <td>{{ ag.pta_right|default:"—" }}</td>
                      <td>{{ ag.pta_left|default:"—" }}</td>
                      <td class="text-truncate" style="max-width: 280px;">{{ ag.comments|default:"" }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center text-secondary py-4">
                <div class="mb-2" style="font-size:1.6rem;"><i class="bi bi-activity"></i></div>
                <div class="fw-semibold">Sin audiometrías registradas.</div>
              </div>
            {% endif %}
          </div>

          <!-- === TAB: Vocal / LDL === -->
          <div id="tab-speech" class="tab-pane fade" role="tabpanel">
            <div class="row g-3">
              <div class="col-12">
                <h6 class="section-title mb-2"><i class="bi bi-chat-dots me-1"></i> Discriminación de la palabra</h6>
                {% if speech %}
                  <ul class="list-group list-group-flush">
                  {% for s in speech %}
                    <li class="list-group-item">
                      <div class="d-flex justify-content-between flex-wrap gap-2">
                        <strong>{{ s.date }}</strong>
                        <span class="text-secondary small">{{ s.get_ear_display }}</span>
                      </div>
                      <div class="small mt-1">
                        <span class="pill" style="margin-right:.25rem;">SRT: {{ s.srt|default:"—" }} dB HL</span>
                        <span class="pill">WRS: {{ s.wrs_percent|default:"—" }}% @ {{ s.wrs_level_db|default:"—" }} dB HL</span>
                      </div>
                    </li>
                  {% endfor %}
                  </ul>
                {% else %}
                  <div class="text-secondary small">Sin registros.</div>
                {% endif %}
              </div>

              <div class="col-12">
                <h6 class="section-title mb-2"><i class="bi bi-soundwave me-1"></i> LDL reciente</h6>
                {% if ldl %}
                  <ul class="list-group list-group-flush">
                  {% for l in ldl %}
                    <li class="list-group-item">
                      <div class="d-flex justify-content-between flex-wrap gap-2">
                        <strong>{{ l.date }}</strong>
                        <span class="text-secondary small">{{ l.get_ear_display }}</span>
                      </div>
                      <div class="small mt-1 d-flex flex-wrap gap-2">
                        <span class="pill">500: {{ l.ldl_500|default:"—" }}</span>
                        <span class="pill">1k: {{ l.ldl_1k|default:"—" }}</span>
                        <span class="pill">2k: {{ l.ldl_2k|default:"—" }}</span>
                        <span class="pill">4k: {{ l.ldl_4k|default:"—" }}</span>
                        <span class="text-secondary small ms-1">(dB HL)</span>
                      </div>
                    </li>
                  {% endfor %}
                  </ul>
                {% else %}
                  <div class="text-secondary small">Sin registros.</div>
                {% endif %}
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
